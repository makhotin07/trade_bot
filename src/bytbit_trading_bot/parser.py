"""
–ü–∞—Ä—Å–µ—Ä Telegram –∫–∞–Ω–∞–ª–∞
"""
import re
import logging
import asyncio
from datetime import datetime, timezone
from telethon import TelegramClient, events
from .utils import parse_result_date, load_json, save_json, TOKENS_FILE
from .config import API_ID, API_HASH, SESSION_NAME, CHANNEL, POST_REGEX, MESSAGES_HISTORY_LIMIT
from .scheduler import schedule_token

logger = logging.getLogger(__name__)

client = None


async def process_message(message_text):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ –∏ –Ω–∞—Ö–æ–¥–∏—Ç –Ω–æ–≤—ã–µ –∞–Ω–æ–Ω—Å—ã.
    
    –õ–æ–≥–∏–∫–∞:
    - –ü–∞—Ä—Å–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –≤—ã—Ä–∞–∂–µ–Ω–∏—é
    - –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏ –¥–∞—Ç—É Result
    - –ï—Å–ª–∏ –≤—Ä–µ–º—è Result –≤ –±—É–¥—É—â–µ–º ‚Äî —Å—Ç–∞–≤–∏—Ç –∑–∞–¥–∞—á—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
    
    Args:
        message_text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        
    Returns:
        True –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω, False –µ—Å–ª–∏ –Ω–µ—Ç
    """
    if not message_text:
        return False
    
    # –ü–∞—Ä—Å–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —Ä–µ–≥—É–ª—è—Ä–∫–µ (–∏—â–µ–º —Ñ–æ—Ä–º–∞—Ç: –¢–û–ö–ï–ù\n...Result DD.MM.YYYY HH:MM UTC –∏–ª–∏ –±–µ–∑ UTC)
    match = re.match(POST_REGEX, message_text, re.DOTALL | re.MULTILINE)
    
    if not match:
        logger.debug(f"[Telethon] –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É: {message_text[:100]}")
        return False
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω –∏ –¥–∞—Ç—É Result
    token = match.group("token")
    result_date_str = match.group("result_date")
    
    logger.info(f"[Telethon] –ù–∞–π–¥–µ–Ω –∞–Ω–æ–Ω—Å: —Ç–æ–∫–µ–Ω={token}, Result={result_date_str}")
    
    # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≤ datetime –æ–±—ä–µ–∫—Ç
    result_date = parse_result_date(result_date_str)
    
    if not result_date:
        logger.error(f"[Telethon] –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞—Ç—É: {result_date_str}")
        return False
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ Result –≤ –±—É–¥—É—â–µ–º
    now = datetime.now(result_date.tzinfo if result_date.tzinfo else timezone.utc)
    if result_date <= now:
        logger.info(f"[Telethon] –î–∞—Ç–∞ {result_date_str} —É–∂–µ –ø—Ä–æ—à–ª–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
        return False
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å)
    tokens = load_json(TOKENS_FILE)
    token_key = f"{token}_{result_date_str}"
    
    if token_key in tokens:
        logger.info(f"[Telethon] –¢–æ–∫–µ–Ω {token} —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
        return False
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ —Ñ–∞–π–ª
    tokens[token_key] = {
        "token": token,
        "result_date": result_date_str,
        "result_datetime": result_date.isoformat(),
        "added_at": datetime.now().isoformat()
    }
    save_json(TOKENS_FILE, tokens)
    
    # –°—Ç–∞–≤–∏–º –∑–∞–¥–∞—á—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å (–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫)
    schedule_token(token, result_date)
    
    logger.info(f"[Telethon] ‚úÖ –¢–æ–∫–µ–Ω {token} –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ {result_date}")
    return True


async def check_recent_messages():
    """
    –ß–∏—Ç–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ @TokenSplashBybit –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.
    
    –ù–∞—Ö–æ–¥–∏—Ç –Ω–æ–≤—ã–µ –∞–Ω–æ–Ω—Å—ã –∏ —Å—Ç–∞–≤–∏—Ç –∑–∞–¥–∞—á–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –±—É–¥—É—â–∏—Ö —Å–æ–±—ã—Ç–∏–π.
    """
    try:
        logger.info(f"[Telethon] üìñ –ß–∏—Ç–∞—é –ø–æ—Å–ª–µ–¥–Ω–∏–µ {MESSAGES_HISTORY_LIMIT} —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ {CHANNEL}...")
        
        messages_processed = 0
        tokens_found = 0
        
        # –ß–∏—Ç–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∫–∞–Ω–∞–ª–∞
        async for message in client.iter_messages(CHANNEL, limit=MESSAGES_HISTORY_LIMIT):
            if message.text:
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–∞—Ö–æ–¥–∏—Ç –∞–Ω–æ–Ω—Å—ã –∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á–∏)
                if await process_message(message.text):
                    tokens_found += 1
                messages_processed += 1
        
        logger.info(f"[Telethon] ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ {messages_processed} —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–∞–π–¥–µ–Ω–æ {tokens_found} –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ —Å –±—É–¥—É—â–∏–º–∏ –¥–∞—Ç–∞–º–∏")
        
    except Exception as e:
        error_msg = str(e)
        if "bot" in error_msg.lower() or "BotMethodInvalidError" in error_msg:
            logger.error(f"[Telethon] ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π: –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∫–∞–∫ –±–æ—Ç")
            logger.error(f"[Telethon] ‚ö†Ô∏è  –†–µ—à–µ–Ω–∏–µ: —É–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª my_session.session –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞")
            logger.error(f"[Telethon] ‚ö†Ô∏è  –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ 'Please enter your phone (or bot token):' –≤–≤–µ–¥–∏—Ç–µ –ù–û–ú–ï–† –¢–ï–õ–ï–§–û–ù–ê, –∞ –Ω–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞!")
            logger.info(f"[Telethon] ‚ö†Ô∏è  –ë–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è")
        else:
            logger.error(f"[Telethon] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: {e}", exc_info=True)


async def start_telethon():
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç Telethon –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∫–∞–Ω–∞–ª–∞.
    
    –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
    1. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Telegram —á–µ—Ä–µ–∑ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç (–Ω—É–∂–µ–Ω API ID –∏ Hash)
    2. –ß–∏—Ç–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ @TokenSplashBybit
    3. –ù–∞—Ö–æ–¥–∏—Ç –Ω–æ–≤—ã–µ –∞–Ω–æ–Ω—Å—ã
    4. –ï—Å–ª–∏ –≤—Ä–µ–º—è Result –≤ –±—É–¥—É—â–µ–º ‚Äî —Å—Ç–∞–≤–∏—Ç –∑–∞–¥–∞—á—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
    5. –°–ª—É—à–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    """
    global client
    
    if not API_ID or not API_HASH:
        logger.error("[Telethon] API_ID –∏–ª–∏ API_HASH –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã")
        return
    
    # –°–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç Telethon —Å –≤–∞—à–∏–º–∏ API credentials
    client = TelegramClient(SESSION_NAME, API_ID, API_HASH)
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏)
    @client.on(events.NewMessage(chats=CHANNEL))
    async def handler(event):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∫–∞–Ω–∞–ª–∞"""
        try:
            await process_message(event.message.text)
        except Exception as e:
            logger.error(f"[Telethon] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}", exc_info=True)
    
    try:
        # –®–∞–≥ 1: –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Telegram —á–µ—Ä–µ–∑ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç (–ù–ï —á–µ—Ä–µ–∑ –±–æ—Ç–∞!)
        # –í–∞–∂–Ω–æ: client.start() –¥–æ–ª–∂–µ–Ω –∑–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∞ –Ω–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
        # –ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å "Please enter your phone (or bot token):" - –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        await client.start()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∞ –Ω–µ –∫–∞–∫ –±–æ—Ç
        me = await client.get_me()
        if me.bot:
            logger.error("[Telethon] –û–®–ò–ë–ö–ê: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ –∫–∞–∫ –±–æ—Ç! –ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
            logger.error("[Telethon] –£–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª my_session.session –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞")
            return
        
        logger.info(f"[Telethon] –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Telegram –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {me.first_name} (@{me.username})")
        
        # –®–∞–≥ 2: –ß–∏—Ç–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∫–∞–Ω–∞–ª–∞
        # –®–∞–≥ 3: –ù–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã–µ –∞–Ω–æ–Ω—Å—ã
        # –®–∞–≥ 4: –ï—Å–ª–∏ –≤—Ä–µ–º—è Result –≤ –±—É–¥—É—â–µ–º ‚Äî —Å—Ç–∞–≤–∏–º –∑–∞–¥–∞—á—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        await check_recent_messages()
        
        # –®–∞–≥ 5: –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–ª—É—à–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        logger.info("[Telethon] –ù–∞—á–∏–Ω–∞—é —Å–ª—É—à–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∫–∞–Ω–∞–ª–∞...")
        await client.run_until_disconnected()
    except Exception as e:
        logger.error(f"[Telethon] –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: {e}", exc_info=True)
        raise

